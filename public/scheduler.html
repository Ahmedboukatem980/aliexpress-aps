<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta name="theme-color" content="#FF9800">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>لوحة الجدولة</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; background: #1a1a2e; min-height: 100vh; color: #fff; }
        .header { background: linear-gradient(135deg, #FF9800, #F57C00); padding: 60px 20px 40px; border-radius: 0 0 30px 30px; text-align: center; position: relative; }
        .header h1 { font-size: 26px; font-weight: 700; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .back-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 40px; height: 40px; color: #fff; font-size: 18px; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; }
        .content { padding: 20px; max-width: 700px; margin: 0 auto; }
        
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: #16213e; border-radius: 12px; padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .stat-card .number { font-size: 28px; font-weight: 700; color: #FF9800; }
        .stat-card .label { font-size: 11px; color: #888; margin-top: 5px; }
        
        .date-nav { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .date-nav button { background: #16213e; border: none; border-radius: 10px; width: 40px; height: 40px; color: #fff; font-size: 16px; cursor: pointer; }
        .date-nav button:hover { background: #FF9800; }
        .date-nav .current-date { font-size: 18px; font-weight: 700; color: #FF9800; min-width: 200px; text-align: center; }
        
        .timeline { background: #16213e; border-radius: 15px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .timeline-title { font-size: 16px; font-weight: 700; color: #FF9800; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        
        .hour-slot { display: flex; align-items: stretch; border-bottom: 1px solid rgba(255,255,255,0.05); min-height: 60px; }
        .hour-slot:last-child { border-bottom: none; }
        .hour-label { width: 60px; padding: 10px; font-size: 13px; color: #666; font-weight: 600; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .hour-content { flex: 1; padding: 8px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .hour-slot.has-post { background: rgba(255, 152, 0, 0.1); }
        .hour-slot.past { opacity: 0.4; }
        
        .post-chip { background: linear-gradient(135deg, #FF9800, #F57C00); border-radius: 8px; padding: 8px 12px; font-size: 11px; max-width: 100%; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: transform 0.2s; }
        .post-chip:hover { transform: scale(1.02); }
        .post-chip .post-title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .post-chip .post-actions { display: flex; gap: 5px; }
        .post-chip .post-actions button { background: rgba(255,255,255,0.2); border: none; border-radius: 5px; width: 24px; height: 24px; color: #fff; font-size: 10px; cursor: pointer; }
        
        .empty-slot { color: #444; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .add-slot-btn { background: rgba(255, 152, 0, 0.2); border: 1px dashed #FF9800; border-radius: 8px; padding: 8px 15px; font-size: 12px; color: #FF9800; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .add-slot-btn:hover { background: rgba(255, 152, 0, 0.3); }
        
        .suggestions-section { background: #16213e; border-radius: 15px; padding: 20px; margin-top: 20px; border: 1px solid rgba(76, 175, 80, 0.3); }
        .suggestions-section h3 { color: #4CAF50; font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .suggestion-chips { display: flex; flex-wrap: wrap; gap: 10px; }
        .suggestion-chip { background: rgba(76, 175, 80, 0.2); border: 1px solid #4CAF50; border-radius: 20px; padding: 8px 15px; font-size: 12px; color: #4CAF50; cursor: pointer; }
        .suggestion-chip:hover { background: #4CAF50; color: #fff; }
        
        .conflict-warning { background: rgba(255, 68, 68, 0.2); border: 1px solid #ff4444; border-radius: 10px; padding: 12px; margin-top: 15px; display: none; }
        .conflict-warning.show { display: block; }
        .conflict-warning p { color: #ff4444; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 3000; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: #16213e; border-radius: 20px; padding: 25px; max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { color: #FF9800; font-size: 18px; }
        .modal-close { background: none; border: none; color: #888; font-size: 24px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; color: #888; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #2d2d44; background: #1a1a2e; color: #fff; font-family: 'Cairo', sans-serif; font-size: 14px; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #FF9800; }
        .modal-btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-family: 'Cairo', sans-serif; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .modal-btn.primary { background: linear-gradient(135deg, #FF9800, #F57C00); color: #fff; }
        .modal-btn.danger { background: #ff4444; color: #fff; }
        
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 12px 25px; border-radius: 25px; display: none; z-index: 4000; font-weight: 600; }
        .toast.show { display: block; animation: fadeInOut 3s ease-in-out; }
        .toast.success { background: #4CAF50; }
        .toast.error { background: #ff4444; }
        @keyframes fadeInOut { 0%, 100% { opacity: 0; } 10%, 90% { opacity: 1; } }
    </style>
</head>
<body>
    <div class="header">
        <a href="/telegram.html" class="back-btn"><i class="fas fa-arrow-right"></i></a>
        <h1><i class="fas fa-calendar-alt"></i> لوحة الجدولة</h1>
        <p>نظم منشوراتك على مدار اليوم</p>
    </div>

    <div class="content">
        <div class="stats-row">
            <div class="stat-card">
                <div class="number" id="todayCount">0</div>
                <div class="label">منشورات اليوم</div>
            </div>
            <div class="stat-card">
                <div class="number" id="pendingCount">0</div>
                <div class="label">قيد الانتظار</div>
            </div>
            <div class="stat-card">
                <div class="number" id="publishedCount">0</div>
                <div class="label">تم نشرها</div>
            </div>
        </div>

        <div class="date-nav">
            <button id="prevDay"><i class="fas fa-chevron-right"></i></button>
            <div class="current-date" id="currentDate"></div>
            <button id="nextDay"><i class="fas fa-chevron-left"></i></button>
        </div>

        <div class="timeline" id="timeline">
            <div class="timeline-title"><i class="fas fa-clock"></i> الجدول الزمني</div>
            <div id="timelineContent"></div>
        </div>

        <div class="suggestions-section" id="suggestionsSection" style="display: none;">
            <h3><i class="fas fa-lightbulb"></i> أوقات مقترحة للنشر</h3>
            <div class="suggestion-chips" id="suggestionChips"></div>
        </div>
    </div>

    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> تعديل المنشور</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>وقت النشر:</label>
                <input type="datetime-local" id="editTime" style="color-scheme: dark;">
            </div>
            <div class="conflict-warning" id="conflictWarning">
                <p><i class="fas fa-exclamation-triangle"></i> <span id="conflictText"></span></p>
            </div>
            <div class="form-group">
                <label>معاينة المنشور:</label>
                <textarea id="editMessage" rows="5" readonly style="background: #0f0f1a;"></textarea>
            </div>
            <button class="modal-btn primary" onclick="savePostChanges()"><i class="fas fa-save"></i> حفظ التغييرات</button>
            <button class="modal-btn danger" onclick="deletePost()"><i class="fas fa-trash"></i> حذف المنشور</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let allPosts = [];
        let currentDate = new Date();
        let editingPostId = null;

        const timelineContent = document.getElementById('timelineContent');
        const currentDateEl = document.getElementById('currentDate');
        const todayCountEl = document.getElementById('todayCount');
        const pendingCountEl = document.getElementById('pendingCount');
        const publishedCountEl = document.getElementById('publishedCount');
        const suggestionsSection = document.getElementById('suggestionsSection');
        const suggestionChips = document.getElementById('suggestionChips');
        const editModal = document.getElementById('editModal');
        const editTime = document.getElementById('editTime');
        const editMessage = document.getElementById('editMessage');
        const conflictWarning = document.getElementById('conflictWarning');
        const conflictText = document.getElementById('conflictText');
        const toast = document.getElementById('toast');

        function showToast(msg, type = '') {
            toast.textContent = msg;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.className = 'toast', 3000);
        }

        function formatDate(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('ar-DZ', options);
        }

        function formatHour(hour) {
            if (hour === 0) return '12 صباحاً';
            if (hour === 12) return '12 مساءً';
            if (hour < 12) return `${hour} صباحاً`;
            return `${hour - 12} مساءً`;
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function isPast(date, hour) {
            const now = new Date();
            const slotTime = new Date(date);
            slotTime.setHours(hour, 0, 0, 0);
            return slotTime < now;
        }

        async function loadPosts() {
            try {
                const res = await fetch('/api/scheduled-posts');
                const data = await res.json();
                if (data.success) {
                    allPosts = data.posts;
                    updateStats();
                    renderTimeline();
                    loadSuggestions();
                }
            } catch (e) {
                showToast('خطأ في تحميل المنشورات', 'error');
            }
        }

        function updateStats() {
            const today = new Date().toDateString();
            const todayPosts = allPosts.filter(p => new Date(p.scheduledTime).toDateString() === today);
            const pending = allPosts.filter(p => p.status === 'pending');
            const published = allPosts.filter(p => p.status === 'published');

            todayCountEl.textContent = todayPosts.length;
            pendingCountEl.textContent = pending.length;
            publishedCountEl.textContent = published.length;
        }

        function renderTimeline() {
            currentDateEl.textContent = formatDate(currentDate);
            
            const dayPosts = allPosts.filter(p => {
                const postDate = new Date(p.scheduledTime).toDateString();
                return postDate === currentDate.toDateString();
            });

            let html = '';
            
            // Show hours from 8 AM to 11 PM
            for (let hour = 8; hour <= 23; hour++) {
                const hourPosts = dayPosts.filter(p => new Date(p.scheduledTime).getHours() === hour);
                const hasPost = hourPosts.length > 0;
                const past = isPast(currentDate, hour);
                
                html += `
                    <div class="hour-slot ${hasPost ? 'has-post' : ''} ${past ? 'past' : ''}">
                        <div class="hour-label">${formatHour(hour)}</div>
                        <div class="hour-content">
                            ${hourPosts.map(p => `
                                <div class="post-chip" onclick="openEditModal('${p.id}')">
                                    <i class="fas fa-file-alt"></i>
                                    <span class="post-title">${p.title || (p.message ? p.message.substring(0, 30) + '...' : 'بدون عنوان')}</span>
                                    <div class="post-actions">
                                        <button onclick="event.stopPropagation(); openEditModal('${p.id}')"><i class="fas fa-edit"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                            ${!hasPost && !past ? `
                                <button class="add-slot-btn" onclick="goToSchedule(${hour})">
                                    <i class="fas fa-plus"></i> إضافة منشور
                                </button>
                            ` : ''}
                            ${!hasPost && past ? '<span class="empty-slot"><i class="fas fa-minus"></i> انتهى الوقت</span>' : ''}
                        </div>
                    </div>
                `;
            }
            
            timelineContent.innerHTML = html;
        }

        async function loadSuggestions() {
            try {
                const res = await fetch(`/api/scheduler/suggestions?date=${currentDate.toISOString()}`);
                const data = await res.json();
                if (data.success && data.suggestions.length > 0) {
                    suggestionsSection.style.display = 'block';
                    suggestionChips.innerHTML = data.suggestions.map(time => {
                        const d = new Date(time);
                        return `<span class="suggestion-chip" onclick="goToScheduleWithTime('${time}')">${formatHour(d.getHours())}</span>`;
                    }).join('');
                } else {
                    suggestionsSection.style.display = 'none';
                }
            } catch (e) {
                suggestionsSection.style.display = 'none';
            }
        }

        function formatLocalDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function goToSchedule(hour) {
            const scheduleTime = new Date(currentDate);
            scheduleTime.setHours(hour, 0, 0, 0);
            const localString = formatLocalDateTime(scheduleTime);
            window.location.href = `/telegram.html?scheduleTime=${localString}`;
        }

        function goToScheduleWithTime(isoTime) {
            const date = new Date(isoTime);
            const localString = formatLocalDateTime(date);
            window.location.href = `/telegram.html?scheduleTime=${localString}`;
        }

        function openEditModal(postId) {
            const post = allPosts.find(p => p.id === postId);
            if (!post) return;
            
            editingPostId = postId;
            const localTime = new Date(post.scheduledTime);
            localTime.setMinutes(localTime.getMinutes() - localTime.getTimezoneOffset());
            editTime.value = localTime.toISOString().slice(0, 16);
            editMessage.value = post.message;
            conflictWarning.classList.remove('show');
            editModal.classList.add('show');
        }

        function closeModal() {
            editModal.classList.remove('show');
            editingPostId = null;
        }

        editTime.onchange = async () => {
            if (!editTime.value) return;
            
            try {
                const res = await fetch(`/api/scheduler/conflicts?time=${new Date(editTime.value).toISOString()}&exclude=${editingPostId}`);
                const data = await res.json();
                if (data.success && data.conflicts.length > 0) {
                    conflictText.textContent = `يوجد ${data.conflicts.length} منشور آخر قريب من هذا الوقت (فارق ${data.conflicts[0].diffMinutes} دقيقة)`;
                    conflictWarning.classList.add('show');
                } else {
                    conflictWarning.classList.remove('show');
                }
            } catch (e) {
                conflictWarning.classList.remove('show');
            }
        };

        async function savePostChanges() {
            if (!editingPostId || !editTime.value) return;
            
            try {
                const res = await fetch(`/api/scheduled-posts/${editingPostId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scheduledTime: new Date(editTime.value).toISOString()
                    })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('تم تحديث الموعد بنجاح ✅', 'success');
                    closeModal();
                    loadPosts();
                } else {
                    showToast(data.error || 'فشل التحديث', 'error');
                }
            } catch (e) {
                showToast('خطأ في الاتصال', 'error');
            }
        }

        async function deletePost() {
            if (!editingPostId) return;
            if (!confirm('هل تريد حذف هذا المنشور المجدول؟')) return;
            
            try {
                await fetch(`/api/scheduled-posts/${editingPostId}`, { method: 'DELETE' });
                showToast('تم حذف المنشور', 'success');
                closeModal();
                loadPosts();
            } catch (e) {
                showToast('خطأ في الحذف', 'error');
            }
        }

        document.getElementById('prevDay').onclick = () => {
            currentDate.setDate(currentDate.getDate() - 1);
            renderTimeline();
            loadSuggestions();
        };

        document.getElementById('nextDay').onclick = () => {
            currentDate.setDate(currentDate.getDate() + 1);
            renderTimeline();
            loadSuggestions();
        };

        // Close modal on outside click
        editModal.onclick = (e) => {
            if (e.target === editModal) closeModal();
        };

        loadPosts();
    </script>
</body>
</html>
