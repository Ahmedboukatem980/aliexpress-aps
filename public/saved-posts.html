<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta name="theme-color" content="#9C27B0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>المنشورات المحفوظة</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; background: #1a1a2e; min-height: 100vh; color: #fff; }
        .header { background: linear-gradient(135deg, #9C27B0, #7B1FA2); padding: 60px 20px 40px; border-radius: 0 0 30px 30px; text-align: center; position: relative; }
        .header h1 { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .back-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 40px; height: 40px; color: #fff; font-size: 18px; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; }
        .content { padding: 30px 20px; max-width: 600px; margin: 0 auto; }
        
        .stats-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #16213e; border-radius: 12px; }
        .stats-count { font-size: 14px; color: #888; }
        .stats-count span { color: #9C27B0; font-weight: 700; }
        .clear-btn { background: #ff4444; border: none; border-radius: 8px; color: #fff; padding: 10px 20px; font-family: 'Cairo'; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .clear-btn:disabled { opacity: 0.5; }
        
        .posts-list { display: flex; flex-direction: column; gap: 15px; }
        
        .post-card { background: #16213e; border-radius: 15px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
        .post-header { display: flex; gap: 15px; padding: 15px; align-items: flex-start; }
        .post-image { width: 80px; height: 80px; object-fit: cover; border-radius: 10px; background: #2d2d44; }
        .post-image-placeholder { width: 80px; height: 80px; background: #2d2d44; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #555; font-size: 24px; }
        .post-info { flex: 1; min-width: 0; }
        .post-title { font-weight: 600; font-size: 15px; margin-bottom: 8px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .post-price { font-size: 14px; color: #4CAF50; font-weight: 700; margin-bottom: 5px; }
        .post-date { font-size: 12px; color: #888; }
        
        .post-actions { display: grid; grid-template-columns: 1fr 1fr 50px; gap: 10px; padding: 0 15px 15px; }
        .action-btn { border: none; border-radius: 10px; color: #fff; padding: 12px; font-family: 'Cairo'; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
        .action-btn:active { transform: scale(0.95); }
        .republish-btn { background: linear-gradient(135deg, #0088cc, #0077b5); }
        .edit-btn { background: linear-gradient(135deg, #FF9800, #F57C00); }
        .delete-btn { background: #ff4444; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #666; }
        .empty-state i { font-size: 60px; margin-bottom: 20px; opacity: 0.3; }
        .empty-state h3 { margin-bottom: 10px; color: #888; }
        .empty-state a { color: #9C27B0; text-decoration: none; }
        
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 15px 30px; border-radius: 25px; display: none; z-index: 2000; font-weight: 600; }
        .toast.show { display: block; animation: fadeInOut 3s ease-in-out; }
        .toast.success { background: #4CAF50; }
        .toast.error { background: #ff4444; }
        @keyframes fadeInOut { 0%, 100% { opacity: 0; } 10%, 90% { opacity: 1; } }
        
        .loading { text-align: center; padding: 40px; }
        .loading i { font-size: 40px; color: #9C27B0; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="header">
        <a href="/" class="back-btn"><i class="fas fa-arrow-right"></i></a>
        <h1><i class="fas fa-history"></i> المنشورات المحفوظة</h1>
        <p>أعد نشر منتجاتك بضغطة واحدة</p>
    </div>

    <div class="content">
        <div class="stats-bar">
            <div class="stats-count"><span id="postsCount">0</span> منشور محفوظ</div>
            <button class="clear-btn" id="clearAllBtn" style="display: none;">
                <i class="fas fa-trash"></i> مسح الكل
            </button>
        </div>

        <div id="loadingState" class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p style="margin-top: 15px; color: #888;">جاري التحميل...</p>
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="fas fa-inbox"></i>
            <h3>لا توجد منشورات محفوظة</h3>
            <p>عند نشر أي منتج في تيليجرام، سيتم حفظه هنا تلقائياً</p>
            <p style="margin-top: 15px;"><a href="/telegram.html">انتقل لصفحة النشر <i class="fas fa-arrow-left"></i></a></p>
        </div>

        <div id="postsList" class="posts-list"></div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let settings = JSON.parse(localStorage.getItem('appSettings')) || {};
        let savedPosts = [];

        function showToast(msg, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.className = 'toast', 3000);
        }

        async function loadPosts() {
            try {
                const res = await fetch('/api/saved-posts');
                const data = await res.json();
                
                document.getElementById('loadingState').style.display = 'none';
                
                if (data.success && data.posts.length > 0) {
                    savedPosts = data.posts;
                    document.getElementById('postsCount').textContent = data.posts.length;
                    document.getElementById('clearAllBtn').style.display = 'flex';
                    document.getElementById('emptyState').style.display = 'none';
                    renderPosts(data.posts);
                } else {
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('postsList').innerHTML = '';
                    document.getElementById('clearAllBtn').style.display = 'none';
                    document.getElementById('postsCount').textContent = '0';
                }
            } catch (e) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                showToast('خطأ في تحميل المنشورات', 'error');
            }
        }

        function renderPosts(posts) {
            const list = document.getElementById('postsList');
            list.innerHTML = posts.map(p => `
                <div class="post-card" data-id="${p.id}">
                    <div class="post-header">
                        ${p.image ? 
                            `<img src="${p.image}" class="post-image" onerror="this.outerHTML='<div class=\\'post-image-placeholder\\'><i class=\\'fas fa-image\\'></i></div>'">` : 
                            '<div class="post-image-placeholder"><i class="fas fa-image"></i></div>'
                        }
                        <div class="post-info">
                            <div class="post-title">${p.title || 'بدون عنوان'}</div>
                            <div class="post-price">${p.price || ''}</div>
                            <div class="post-date"><i class="fas fa-calendar"></i> ${new Date(p.createdAt).toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
                        </div>
                    </div>
                    <div class="post-actions">
                        <button class="action-btn republish-btn" onclick="republishPost('${p.id}', this)">
                            <i class="fab fa-telegram"></i> إعادة النشر
                        </button>
                        <button class="action-btn edit-btn" onclick="editPost('${p.id}')">
                            <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="action-btn delete-btn" onclick="deletePost('${p.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function republishPost(id, btn) {
            const post = savedPosts.find(p => p.id === id);
            if (!post) { showToast('لم يتم العثور على المنشور', 'error'); return; }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري النشر...';

            try {
                const credentials = {
                    telegramToken: settings.telegramToken || '',
                    channelId: settings.channelId || '',
                    channelId2: settings.channelId2 || '',
                    channelChoice: 'both'
                };

                const res = await fetch('/api/publish-telegram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: post.title,
                        price: post.price,
                        link: post.link,
                        coupon: post.coupon || null,
                        image: post.image,
                        settings: settings,
                        credentials: credentials,
                        customMessage: post.message
                    })
                });

                const result = await res.json();
                if (result.success) {
                    showToast('تم إعادة النشر بنجاح! ✅', 'success');
                } else {
                    showToast(result.error || 'فشل النشر', 'error');
                }
            } catch (e) {
                showToast('خطأ في الاتصال', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fab fa-telegram"></i> إعادة النشر';
            }
        }

        function editPost(id) {
            const post = savedPosts.find(p => p.id === id);
            if (!post) { showToast('لم يتم العثور على المنشور', 'error'); return; }
            
            const params = new URLSearchParams();
            if (post.title) params.set('title', post.title);
            if (post.price) params.set('price', post.price);
            if (post.link) params.set('link', post.link);
            if (post.image && !post.image.startsWith('data:')) params.set('image', post.image);
            
            window.location.href = '/telegram.html?' + params.toString();
        }

        async function deletePost(id) {
            if (!confirm('هل تريد حذف هذا المنشور؟')) return;
            
            try {
                await fetch(`/api/saved-posts/${id}`, { method: 'DELETE' });
                showToast('تم حذف المنشور', 'success');
                loadPosts();
            } catch (e) {
                showToast('خطأ في الحذف', 'error');
            }
        }

        document.getElementById('clearAllBtn').onclick = async () => {
            if (!confirm('هل تريد حذف جميع المنشورات المحفوظة؟')) return;
            
            try {
                await fetch('/api/saved-posts', { method: 'DELETE' });
                showToast('تم حذف جميع المنشورات', 'success');
                loadPosts();
            } catch (e) {
                showToast('خطأ في الحذف', 'error');
            }
        };

        loadPosts();
    </script>
</body>
</html>
