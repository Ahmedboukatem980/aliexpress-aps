<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta name="theme-color" content="#FF6B35">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json?v=4">
    <title>Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø®ØµÙ… - AliExpress</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; background: #0f0f1a; min-height: 100vh; color: #fff; overflow-x: hidden; }
        
        .header { 
            background: linear-gradient(135deg, #FF6B35, #e85a2a); 
            padding: 70px 20px 60px; 
            border-radius: 0 0 40px 40px; 
            text-align: center; 
            position: relative; 
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
        }
        .header h1 { font-size: 32px; font-weight: 800; margin-bottom: 8px; letter-spacing: -0.5px; }
        .header p { opacity: 0.9; font-size: 15px; font-weight: 400; }
        
        .top-actions {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-btn { 
            background: rgba(255,255,255,0.2); border: none; 
            border-radius: 12px; width: 42px; height: 42px; 
            color: #fff; font-size: 18px; cursor: pointer;
            backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .telegram-page-btn { 
            background: #0088cc; border: none; 
            border-radius: 12px; width: 42px; height: 42px; 
            color: #fff; font-size: 18px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            text-decoration: none;
            box-shadow: 0 4px 15px rgba(0, 136, 204, 0.4);
            transition: all 0.2s;
        }
        .settings-btn:active, .telegram-page-btn:active { transform: scale(0.9); }
        
        .search-container { 
            margin: -30px 20px 0; 
            background: #fff; 
            border-radius: 18px; 
            padding: 6px; 
            display: flex; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            z-index: 10;
        }
        .search-input { 
            flex: 1; border: none; padding: 15px 18px; 
            font-size: 14px; font-family: 'Cairo', sans-serif; 
            direction: rtl; background: transparent; color: #333;
        }
        .search-input::placeholder { color: #999; }
        .search-input:focus { outline: none; }
        .search-btn { 
            background: #FF6B35; border: none; 
            border-radius: 14px; width: 50px; height: 50px; 
            cursor: pointer; display: flex; align-items: center; 
            justify-content: center; color: #fff; font-size: 20px;
            transition: all 0.2s;
        }
        .search-btn:active { transform: scale(0.95); }
        .search-btn:disabled { background: #ccc; }
        
        .content { padding: 30px 20px; }
        .section-title { font-size: 19px; font-weight: 700; margin: 25px 0 15px; display: flex; align-items: center; gap: 10px; }
        .section-title::after { content: ""; flex: 1; height: 1px; background: rgba(255,255,255,0.1); }
        
        .error-msg { background: rgba(255,68,68,0.1); border: 1px solid #ff4444; border-radius: 12px; padding: 15px; text-align: center; color: #ff4444; margin-bottom: 20px; display: none; font-size: 14px; }
        .error-msg.show { display: block; }
        
        .loading { text-align: center; padding: 40px; display: none; }
        .loading.show { display: block; }
        .loading i { font-size: 40px; color: #FF6B35; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .results { display: none; }
        .results.show { display: block; }
        
        .product-card { background: #16213e; border-radius: 20px; overflow: hidden; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .product-image { width: 100%; height: 230px; object-fit: cover; }
        .product-title { padding: 18px 18px 8px; font-size: 16px; line-height: 1.5; font-weight: 600; color: #eee; text-align: right; }
        .product-price-row { padding: 0 18px 10px; display: flex; align-items: center; justify-content: flex-end; gap: 12px; }
        .product-price { font-size: 22px; font-weight: 800; color: #FF6B35; }
        .product-original-price { font-size: 14px; color: #777; text-decoration: line-through; }
        .product-discount { background: #4CAF50; color: #fff; padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: 700; }
        
        .product-info { padding: 0 18px 18px; display: flex; justify-content: flex-end; gap: 15px; flex-wrap: wrap; font-size: 12px; color: #888; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 12px; }
        .product-info i { color: #FF6B35; }
        
        .link-card { background: #1a1a2e; border-radius: 18px; padding: 18px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.08); transition: transform 0.2s; }
        .link-card:active { transform: scale(0.98); }
        .link-header { display: flex; align-items: center; justify-content: flex-end; margin-bottom: 10px; }
        .link-header i { color: #FF6B35; margin-left: 10px; font-size: 16px; }
        .link-header span { font-weight: 700; font-size: 15px; }
        .link-text { color: #666; font-size: 11px; word-break: break-all; margin-bottom: 15px; direction: ltr; text-align: right; opacity: 0.6; }
        
        .link-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .action-btn { 
            display: flex; align-items: center; justify-content: center; 
            gap: 8px; padding: 12px 5px; border-radius: 12px; border: none; 
            cursor: pointer; font-family: 'Cairo', sans-serif; font-size: 13px; 
            color: #fff; font-weight: 700; transition: all 0.2s;
        }
        .copy-btn { background: #FF6B35; }
        .open-btn { background: #4CAF50; }
        .tele-btn { background: #0088cc; grid-column: span 2; }
        .share-btn { background: #673AB7; grid-column: span 2; }
        
        .warning-card { background: rgba(255, 165, 0, 0.1); border-radius: 15px; padding: 15px; text-align: center; margin-top: 25px; color: #FFA500; display: flex; align-items: center; justify-content: center; gap: 10px; border: 1px dashed rgba(255, 165, 0, 0.3); font-size: 14px; }
        
        .telegram-section { background: #16213e; border-radius: 20px; padding: 20px; margin-top: 25px; border: 1px solid rgba(0, 136, 204, 0.3); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .telegram-section h3 { color: #0088cc; margin-bottom: 18px; display: flex; align-items: center; justify-content: flex-end; gap: 10px; font-size: 18px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; color: #888; font-size: 13px; text-align: right; padding-right: 5px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border-radius: 10px; border: 1px solid #2d2d44; background: #1a1a2e; color: #fff; font-family: 'Cairo', sans-serif; font-size: 14px; direction: rtl; transition: border-color 0.2s; }
        .form-group input:focus { outline: none; border-color: #FF6B35; }
        
        .publish-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #0088cc, #0077b5); border: none; border-radius: 12px; color: #fff; font-family: 'Cairo', sans-serif; font-size: 16px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 5px 15px rgba(0, 136, 204, 0.3); }
        .publish-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .empty-state { text-align: center; padding: 80px 20px; color: #444; }
        .empty-state i { font-size: 70px; margin-bottom: 20px; opacity: 0.2; display: block; }
        .empty-state p { font-size: 16px; font-weight: 600; }
        
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 12px 25px; border-radius: 30px; display: none; z-index: 5000; font-size: 14px; font-weight: 600; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .toast.show { display: block; animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        
        /* Modal Design */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 4000; overflow-y: auto; padding: 20px; backdrop-filter: blur(5px); }
        .modal.show { display: flex; align-items: flex-start; justify-content: center; }
        .modal-content { background: #16213e; width: 100%; max-width: 500px; border-radius: 25px; padding: 25px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid #2d2d44; padding-bottom: 15px; }
        .modal-header h2 { color: #FF6B35; font-size: 22px; font-weight: 800; }
        .modal-close { background: rgba(255,255,255,0.05); border: none; color: #888; width: 35px; height: 35px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .save-btn { width: 100%; padding: 15px; background: #4CAF50; border: none; border-radius: 12px; color: #fff; font-family: 'Cairo', sans-serif; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3); }
        .reset-btn { width: 100%; padding: 12px; background: transparent; border: 1px solid #ff4444; border-radius: 12px; color: #ff4444; font-family: 'Cairo', sans-serif; font-size: 14px; cursor: pointer; margin-top: 15px; transition: all 0.2s; }
        .reset-btn:active { background: rgba(255, 68, 68, 0.1); }
        .settings-hint { font-size: 11px; color: #666; margin-top: 4px; padding-right: 5px; }
        
        .install-prompt { position: fixed; bottom: 20px; left: 20px; right: 20px; background: #fff; color: #333; padding: 15px 20px; border-radius: 20px; display: none; z-index: 3500; align-items: center; justify-content: space-between; box-shadow: 0 10px 40px rgba(0,0,0,0.4); border: 1px solid #eee; }
        .install-prompt.show { display: flex; }
        .install-prompt span { font-size: 13px; font-weight: 600; flex: 1; margin-right: 10px; line-height: 1.4; }
        .install-btn { background: #FF6B35; color: #fff; border: none; padding: 8px 20px; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; }

        hr { border: none; border-top: 1px solid rgba(255,255,255,0.05); margin: 20px 0; }
    </style>
</head>
<body>
    <div class="header">
        <div class="top-actions">
            <button class="settings-btn" onclick="openSettings()"><i class="fas fa-cog"></i></button>
            <div style="display: flex; gap: 10px;">
                <button id="mainInstallBtn" class="settings-btn" style="background: #FF6B35; color: white;" onclick="installApp()"><i class="fas fa-download"></i></button>
                <a href="/saved-posts.html" style="background: #E91E63; border: none; border-radius: 12px; width: 42px; height: 42px; color: #fff; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; text-decoration: none; box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);"><i class="fas fa-history"></i></a>
                <a href="/discover.html" class="discover-page-btn" style="background: #9C27B0; border: none; border-radius: 12px; width: 42px; height: 42px; color: #fff; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; text-decoration: none; box-shadow: 0 4px 15px rgba(156, 39, 176, 0.4);"><i class="fas fa-magic"></i></a>
                <a href="/collections.html" class="collections-page-btn" style="background: #673AB7; border: none; border-radius: 12px; width: 42px; height: 42px; color: #fff; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; text-decoration: none; box-shadow: 0 4px 15px rgba(103, 58, 183, 0.4);"><i class="fas fa-layer-group"></i></a>
                <a href="/telegram.html" class="telegram-page-btn"><i class="fab fa-telegram"></i></a>
            </div>
        </div>
        <h1>Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø®ØµÙ…</h1>
        <p>Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø¹Ø±ÙˆØ¶ AliExpress</p>
    </div>

    <div class="search-container">
        <input type="text" class="search-input" id="urlInput" placeholder="Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬ Ù‡Ù†Ø§...">
        <button class="search-btn" id="searchBtn"><i class="fas fa-search"></i></button>
    </div>

    <div class="content">
        <div class="error-msg" id="errorMsg"></div>
        <div class="loading" id="loading"><i class="fas fa-spinner"></i><p style="margin-top:10px; font-weight:600;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ø±ÙˆØ¶...</p></div>
        
        <div class="empty-state" id="emptyState">
            <i class="fas fa-link"></i>
            <p>Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ù…Ù†ØªØ¬ AliExpress Ù„Ù„Ø¨Ø¯Ø¡</p>
        </div>

        <div class="results" id="results">
            <div class="product-card">
                <img class="product-image" id="productImage" src="" alt="">
                <div style="position: relative;">
                    <div class="product-title" id="productTitle"></div>
                    <button id="refineTitleBtn" class="action-btn" style="width: 100%; margin: 10px 0; padding: 12px; background: #673AB7; font-size: 14px; display: none; justify-content: center; align-items: center; border-radius: 10px;">
                        <i class="fas fa-magic"></i> ØªØ­Ø³ÙŠÙ† Ø¨Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ø°ÙƒÙŠ
                    </button>
                </div>
                <div class="product-price-row">
                    <span class="product-discount" id="productDiscount"></span>
                    <span class="product-original-price" id="productOriginalPrice"></span>
                    <span class="product-price" id="productPrice"></span>
                </div>
                <div class="product-info" id="productInfo"></div>
                <div id="fetchMethodTag" style="padding: 5px 15px; font-size: 11px; background: rgba(255,255,255,0.05); color: #888; text-align: left; display: none; border-top: 1px solid rgba(255,255,255,0.05);">
                    <i class="fas fa-info-circle"></i> ØªÙ… Ø§Ù„Ø¬Ù„Ø¨ Ø¨ÙˆØ§Ø³Ø·Ø©: <span id="fetchMethodName"></span>
                </div>
            </div>

            <div class="section-title">ğŸ‰ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ®ÙÙŠØ¶</div>
            <div id="linksContainer"></div>

            <div class="warning-card" id="warningCard">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="warningText">ØºÙŠÙ‘Ø± Ø§Ù„Ø¨Ù„Ø¯ Ø¥Ù„Ù‰ ÙƒÙ†Ø¯Ø§ ğŸ‡¨ğŸ‡¦</span>
            </div>

            <div class="telegram-section">
                <h3><i class="fab fa-telegram"></i> Ù†Ø´Ø± Ø³Ø±ÙŠØ¹ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©</h3>
                
                <div style="background: rgba(156, 39, 176, 0.1); border: 1px dashed #9C27B0; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <button class="action-btn" id="aiWriteBtn" style="background: #9C27B0; width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-robot"></i> ÙƒØ§ØªØ¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¢Ù„ÙŠ (AI)
                    </button>
                    <p style="font-size: 11px; color: #aaa; text-align: center;">Ø¯Ø¹Ù‡ ÙŠÙƒØªØ¨ Ù„Ùƒ Ù…Ù†Ø´ÙˆØ±Ø§Ù‹ Ø¬Ø°Ø§Ø¨Ø§Ù‹ Ø¨Ø§Ù„Ø¯Ø§Ø±Ø¬Ø© Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠØ©!</p>
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø®ØªØ§Ø±:</label>
                    <select id="linkSelect"><option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø±Ø§Ø¨Ø· --</option></select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©:</label>
                    <select id="channelSelect">
                        <option value="1">Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</option>
                        <option value="2">Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option>
                        <option value="both">ÙƒÙ„Ø§ Ø§Ù„Ù‚Ù†Ø§ØªÙŠÙ†</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ÙƒÙˆØ¯ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                    <input type="text" id="couponInput" placeholder="Ù…Ø«Ø§Ù„: ALIOFFERS5">
                </div>
                
                <div class="form-group">
                    <label>ğŸ“ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ± (AI):</label>
                    <textarea id="aiPreview" style="min-height: 150px; font-size: 13px; background: rgba(255,255,255,0.02);" placeholder="Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ù…ÙˆÙ„Ø¯ Ù‡Ù†Ø§..."></textarea>
                    <p class="settings-hint">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§ Ù‚Ø¨Ù„ Ù†Ø³Ø®Ù‡ Ø£Ùˆ Ù†Ø´Ø±Ù‡.</p>
                </div>

                <button class="publish-btn" id="publishBtn" disabled><i class="fab fa-telegram"></i> Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ø¢Ù†</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            
            <div style="max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <div class="form-group">
                    <label>ğŸ“¢ Ù†Øµ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</label>
                    <input type="text" id="settingPrefix" placeholder="ğŸ“¢ØªØ®ÙÙŠØ¶ Ù„Ù€">
                </div>
                
                <div class="form-group">
                    <label>âœ… Ù†Øµ Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ®ÙÙŠØ¶:</label>
                    <input type="text" id="settingSalePrice" placeholder="âœ…Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ®ÙÙŠØ¶:">
                </div>
                
                <div class="form-group">
                    <label>ğŸ“Œ Ù†Øµ Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø±Ø§Ø¡:</label>
                    <input type="text" id="settingLinkText" placeholder="ğŸ“ŒØ±Ø§Ø¨Ø· Ø§Ù„Ø´Ø±Ø§Ø¡ :">
                </div>
                
                <div class="form-group">
                    <label>ğŸ Ù†Øµ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†:</label>
                    <input type="text" id="settingCouponText" placeholder="ğŸÙƒÙˆØ¨ÙˆÙ†:">
                </div>
                
                <div class="form-group">
                    <label>ğŸ“ Ù†Øµ Ø§Ù„ØªØ°ÙŠÙŠÙ„ (Footer):</label>
                    <textarea id="settingFooter" style="min-height: 80px;"></textarea>
                </div>
                
                <div class="form-group">
                    <label>ğŸ¤– Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨ÙˆØª:</label>
                    <input type="text" id="settingBotLink">
                </div>
                
                <div class="form-group">
                    <label>#ï¸âƒ£ Ø§Ù„Ù‡Ø§Ø´ØªØ§ØºØ§Øª:</label>
                    <input type="text" id="settingHashtags">
                </div>
                
                <div class="form-group">
                    <label>âš ï¸ Ù†Øµ Ø§Ù„ØªØ­Ø°ÙŠØ±:</label>
                    <input type="text" id="settingWarning">
                </div>
                
                <div class="form-group">
                    <label>ğŸ–¼ï¸ Ø¥Ø·Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© (Frame):</label>
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <img src="/frame.jpg" id="currentFramePreview" style="width: 60px; height: 60px; border-radius: 8px; border: 1px solid #2d2d44; object-fit: cover;">
                        <div style="flex: 1;">
                            <input type="file" id="frameUpload" accept="image/*" style="display: none;">
                            <button type="button" onclick="document.getElementById('frameUpload').click()" class="action-btn" style="background: #FF6B35; width: 100%;"><i class="fas fa-upload"></i> ØªØºÙŠÙŠØ± Ø§Ù„Ø¥Ø·Ø§Ø±</button>
                        </div>
                    </div>
                    <p class="settings-hint">ÙŠÙØ¶Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ù…Ø±Ø¨Ø¹Ø© (1:1) ÙˆØ¨ØµÙŠØºØ© JPG Ø£Ùˆ PNG.</p>
                </div>
                
                <div class="form-group">
                    <label>ğŸ·ï¸ Ù„ÙˆÙ‚Ùˆ Ø§Ù„Ù‚Ù†Ø§Ø© (Watermark):</label>
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <img src="/watermark_logo.png" id="currentLogoPreview" style="width: 60px; height: 60px; border-radius: 8px; border: 1px solid #2d2d44; object-fit: contain; background: #1a1a2e;" onerror="this.style.opacity='0.3'">
                        <div style="flex: 1;">
                            <input type="file" id="logoUpload" accept="image/png" style="display: none;">
                            <button type="button" onclick="document.getElementById('logoUpload').click()" class="action-btn" style="background: #9C27B0; width: 100%;"><i class="fas fa-upload"></i> ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ‚Ùˆ</button>
                        </div>
                    </div>
                    <p class="settings-hint">Ø§Ø³ØªØ®Ø¯Ù… PNG Ø¨Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©.</p>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <select id="logoPosition" style="flex: 1; padding: 10px; background: #1a1a2e; border: 1px solid #2d2d44; border-radius: 8px; color: #fff; font-family: 'Cairo', sans-serif;">
                            <option value="top-right">Ø£Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ†</option>
                            <option value="top-left">Ø£Ø¹Ù„Ù‰ ÙŠØ³Ø§Ø±</option>
                            <option value="bottom-right">Ø£Ø³ÙÙ„ ÙŠÙ…ÙŠÙ†</option>
                            <option value="bottom-left">Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø±</option>
                            <option value="center">ÙˆØ³Ø·</option>
                        </select>
                        <select id="logoSize" style="flex: 1; padding: 10px; background: #1a1a2e; border: 1px solid #2d2d44; border-radius: 8px; color: #fff; font-family: 'Cairo', sans-serif;">
                            <option value="small">ØµØºÙŠØ±</option>
                            <option value="medium">Ù…ØªÙˆØ³Ø·</option>
                            <option value="large">ÙƒØ¨ÙŠØ±</option>
                        </select>
                    </div>
                </div>
                
                <hr>
                <h3 style="color: #FF6B35; margin-bottom: 15px; font-size: 16px;">ğŸ” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
                
                <div class="form-group">
                    <label>ğŸ¤– Bot Token:</label>
                    <input type="password" id="settingBotToken">
                </div>
                
                <div class="form-group">
                    <label>ğŸ“¢ Channel ID 1:</label>
                    <input type="text" id="settingChannelId">
                </div>
                
                <div class="form-group">
                    <label>ğŸ“¢ Channel ID 2:</label>
                    <input type="text" id="settingChannelId2">
                </div>
                
                <div class="form-group">
                    <label>ğŸª AliExpress Cookie:</label>
                    <input type="password" id="settingCook">
                </div>
                
                <div class="form-group">
                    <label>ğŸ”‘ App Key:</label>
                    <input type="password" id="settingAppKey">
                </div>
                
                <div class="form-group">
                    <label>ğŸ”’ App Secret:</label>
                    <input type="password" id="settingAppSecret">
                </div>
                
                <hr>
                <h3 style="color: #9C27B0; margin-bottom: 15px; font-size: 16px;">ğŸ¤– Ù…ÙØ§ØªÙŠØ­ Gemini AI</h3>
                
                <div class="form-group">
                    <label>ğŸ”‘ Ù…ÙØ§ØªÙŠØ­ Gemini API (Ø§ÙØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø¨ÙØ§ØµÙ„Ø©):</label>
                    <textarea id="settingGeminiKeys" rows="3" placeholder="key1,key2,key3..." style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #2d2d44; background: #16213e; color: #fff; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
                    <p class="settings-hint">Ø£Ø¶Ù Ø¹Ø¯Ø© Ù…ÙØ§ØªÙŠØ­ Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ù†ÙØ§Ø¯ Ø§Ù„Ø­ØµØ©.</p>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button type="button" id="saveGeminiKeysBtn" onclick="saveGeminiKeys()" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #9C27B0, #7B1FA2); border: none; border-radius: 8px; color: #fff; font-family: 'Cairo', sans-serif; cursor: pointer;"><i class="fas fa-key"></i> Ø­ÙØ¸ Ø§Ù„Ù…ÙØ§ØªÙŠØ­</button>
                        <button type="button" id="checkGeminiStatusBtn" onclick="checkGeminiStatus()" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #4CAF50, #388E3C); border: none; border-radius: 8px; color: #fff; font-family: 'Cairo', sans-serif; cursor: pointer;"><i class="fas fa-sync"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­</button>
                    </div>
                    <p id="geminiStatus" style="font-size: 12px; color: #4CAF50; margin-top: 10px;"></p>
                </div>
            </div>
            
            <button class="save-btn" onclick="saveSettings()"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            <button class="reset-btn" onclick="resetSettings()"><i class="fas fa-undo"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</button>
        </div>
    </div>

    <div class="install-prompt" id="installPrompt">
        <span>Ø«Ø¨Ù‘Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ù‡Ø§ØªÙ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ¬Ø±Ø¨Ø© Ø£Ø³Ø±Ø¹ ÙˆØ£ÙØ¶Ù„</span>
        <button class="install-btn" id="installBtn">ØªØ«Ø¨ÙŠØª</button>
        <button onclick="document.getElementById('installPrompt').classList.remove('show')" style="background:none; border:none; color:#999; font-size:18px; padding-left:10px;">&times;</button>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').classList.add('show');
        });

        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt = null;
                document.getElementById('installPrompt').classList.remove('show');
            } else {
                showToast("ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ«Ø¨ÙŠØª Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙØ­");
            }
        }

        const defaultSettings = {
            prefix: 'ğŸ“¢ØªØ®ÙÙŠØ¶ Ù„Ù€',
            salePrice: 'âœ…Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ®ÙÙŠØ¶:',
            linkText: 'ğŸ“ŒØ±Ø§Ø¨Ø· Ø§Ù„Ø´Ø±Ø§Ø¡ :',
            couponText: 'ğŸÙƒÙˆØ¨ÙˆÙ†:',
            footer: 'âš ï¸ Ù„Ø§ ØªÙ†Ø³ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø±Ø³Ù…ÙŠ Ù„Ù€ AliOffersDz Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„ØªØ®ÙÙŠØ¶Ø§Øª Ù…Ù† AliExpress ğŸ‘‡',
            botLink: '@AliOffersDZ_bot',
            hashtags: '#Aliexpress #Offers',
            warning: 'ØºÙŠÙ‘Ø± Ø§Ù„Ø¨Ù„Ø¯ Ø¥Ù„Ù‰ ÙƒÙ†Ø¯Ø§ ğŸ‡¨ğŸ‡¦',
            telegramToken: '',
            channelId: '',
            channelId2: '@AliOffers_Dz',
            cook: '',
            appKey: '',
            appSecret: '',
        };

        let settings = JSON.parse(localStorage.getItem('appSettings')) || { ...defaultSettings };
        
        function getSettings() { return settings; }

        function openSettings() {
            document.getElementById('settingPrefix').value = settings.prefix || '';
            document.getElementById('settingSalePrice').value = settings.salePrice || '';
            document.getElementById('settingLinkText').value = settings.linkText || '';
            document.getElementById('settingCouponText').value = settings.couponText || '';
            document.getElementById('settingFooter').value = settings.footer || '';
            document.getElementById('settingBotLink').value = settings.botLink || '';
            document.getElementById('settingHashtags').value = settings.hashtags || '';
            document.getElementById('settingWarning').value = settings.warning || '';
            document.getElementById('settingBotToken').value = settings.telegramToken || '';
            document.getElementById('settingChannelId').value = settings.channelId || '';
            document.getElementById('settingChannelId2').value = settings.channelId2 || '';
            document.getElementById('settingCook').value = settings.cook || '';
            document.getElementById('settingAppKey').value = settings.appKey || '';
            document.getElementById('settingAppSecret').value = settings.appSecret || '';
            document.getElementById('settingGeminiKeys').value = '';
            checkGeminiStatus();
            document.getElementById('settingsModal').classList.add('show');
        }
        
        async function saveGeminiKeys() {
            const keys = document.getElementById('settingGeminiKeys').value.trim();
            if (!keys) {
                showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                return;
            }
            try {
                const res = await fetch('/api/gemini-keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keys: keys })
                });
                const result = await res.json();
                if (result.success) {
                    showToast(`ØªÙ… Ø­ÙØ¸ ${result.count} Ù…ÙØªØ§Ø­ Ø¨Ù†Ø¬Ø§Ø­ âœ…`);
                    document.getElementById('settingGeminiKeys').value = '';
                    checkGeminiStatus();
                } else {
                    showToast(result.error || 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…ÙØ§ØªÙŠØ­', 'error');
                }
            } catch (e) {
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
            }
        }
        
        async function checkGeminiStatus() {
            try {
                const res = await fetch('/api/gemini-status');
                const result = await res.json();
                const statusEl = document.getElementById('geminiStatus');
                if (result.count > 0) {
                    statusEl.innerHTML = `âœ… ${result.count} Ù…ÙØªØ§Ø­ Ù…ØªØ§Ø­ | Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${result.currentIndex + 1}`;
                    statusEl.style.color = '#4CAF50';
                } else {
                    statusEl.innerHTML = 'âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙØ§ØªÙŠØ­ Ù…Ø­ÙÙˆØ¸Ø©';
                    statusEl.style.color = '#FF9800';
                }
            } catch (e) {
                console.log('Status check failed');
            }
        }

        function closeSettings() { document.getElementById('settingsModal').classList.remove('show'); }

        function saveSettings() {
            settings.prefix = document.getElementById('settingPrefix').value;
            settings.salePrice = document.getElementById('settingSalePrice').value;
            settings.linkText = document.getElementById('settingLinkText').value;
            settings.couponText = document.getElementById('settingCouponText').value;
            settings.footer = document.getElementById('settingFooter').value;
            settings.botLink = document.getElementById('settingBotLink').value;
            settings.hashtags = document.getElementById('settingHashtags').value;
            settings.warning = document.getElementById('settingWarning').value;
            settings.telegramToken = document.getElementById('settingBotToken').value;
            settings.channelId = document.getElementById('settingChannelId').value;
            settings.channelId2 = document.getElementById('settingChannelId2').value;
            settings.cook = document.getElementById('settingCook').value;
            settings.appKey = document.getElementById('settingAppKey').value;
            settings.appSecret = document.getElementById('settingAppSecret').value;
            
            localStorage.setItem('appSettings', JSON.stringify(settings));
            document.getElementById('warningText').textContent = settings.warning;
            closeSettings();
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
        }

        let currentProductData = null;
        const linkTypes = [
            { key: 'coin', title: 'ØªØ®ÙÙŠØ¶ Ø§Ù„Ø¹Ù…Ù„Ø§Øª', icon: 'fa-coins' },
            { key: 'point', title: 'Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ù…Ù„Ø§Øª', icon: 'fa-star' },
            { key: 'super', title: 'Ø§Ù„Ø³ÙˆØ¨Ø± Ø¯ÙŠÙ„Ø²', icon: 'fa-bolt' },
            { key: 'limit', title: 'Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯', icon: 'fa-clock' },
            { key: 'bundle', title: 'Bundle Deals', icon: 'fa-gift' }
        ];

        const urlInput = document.getElementById('urlInput');
        const searchBtn = document.getElementById('searchBtn');
        const errorMsg = document.getElementById('errorMsg');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const emptyState = document.getElementById('emptyState');
        const productImage = document.getElementById('productImage');
        const productTitle = document.getElementById('productTitle');
        const productPrice = document.getElementById('productPrice');
        const productOriginalPrice = document.getElementById('productOriginalPrice');
        const productDiscount = document.getElementById('productDiscount');
        const productInfo = document.getElementById('productInfo');
        const linksContainer = document.getElementById('linksContainer');
        const toast = document.getElementById('toast');
        const linkSelect = document.getElementById('linkSelect');
        const couponInput = document.getElementById('couponInput');
        const publishBtn = document.getElementById('publishBtn');
        const aiWriteBtn = document.getElementById('aiWriteBtn');
        const aiPreview = document.getElementById('aiPreview');

        aiWriteBtn.onclick = async () => {
            if (!currentProductData) return showToast("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ Ø£ÙˆÙ„Ø§Ù‹");
            aiWriteBtn.disabled = true;
            aiWriteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ£Ù„ÙŠÙ...';
            try {
                const res = await fetch('/api/analyze-product', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: currentProductData.title,
                        price: currentProductData.price,
                        category: 'general'
                    })
                });
                const data = await res.json();
                if (data.success && data.analysis) {
                    const selectedLink = linkSelect.value || 'Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬';
                    const coupon = couponInput.value;
                    let text = `${settings.prefix} ${currentProductData.title}\n\nğŸ”¥ ${data.analysis.hook}\n\n${settings.salePrice} ${currentProductData.price}\n`;
                    if (coupon) text += `${settings.couponText} ${coupon}\n`;
                    text += `\n${settings.linkText} ${selectedLink}\n\n${settings.footer}\n\n${settings.hashtags}`;
                    aiPreview.value = text;
                    await navigator.clipboard.writeText(text);
                    showToast("ØªÙ… Ø§Ù„ØªØ£Ù„ÙŠÙ ÙˆØ§Ù„Ù†Ø³Ø®! âœ¨");
                }
            } catch (err) { showToast("ÙØ´Ù„ Ø§Ù„ØªØ£Ù„ÙŠÙ"); }
            finally { aiWriteBtn.disabled = false; aiWriteBtn.innerHTML = '<i class="fas fa-robot"></i> ÙƒØ§ØªØ¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¢Ù„ÙŠ (AI)'; }
        };

        searchBtn.onclick = search;
        urlInput.onkeypress = (e) => { if (e.key === 'Enter') search(); };

        async function search() {
            const url = urlInput.value.trim();
            if (!url) return showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·');
            errorMsg.classList.remove('show');
            results.classList.remove('show');
            emptyState.style.display = 'none';
            loading.classList.add('show');
            searchBtn.disabled = true;
            try {
                const response = await fetch('/api/affiliate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, credentials: { cook: settings.cook, appKey: settings.appKey, appSecret: settings.appSecret } })
                });
                const data = await response.json();
                if (data.success) {
                    showResults(data.data);
                    document.getElementById('refineTitleBtn').style.display = 'flex';
                }
                else showError(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
            } catch (err) { showError('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„'); }
            finally { loading.classList.remove('show'); searchBtn.disabled = false; }
        }

        const refineTitleBtn = document.getElementById('refineTitleBtn');
        refineTitleBtn.addEventListener('click', async () => {
            const currentTitle = productTitle.textContent;
            if (!currentTitle) return;

            refineTitleBtn.disabled = true;
            refineTitleBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø³ÙŠÙ†...';

            try {
                const response = await fetch('/api/ai-refine-title', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: currentTitle })
                });
                const result = await response.json();
                
                if (result.success) {
                    productTitle.textContent = result.refinedTitle;
                    showToast('ØªÙ… ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    showToast('ÙØ´Ù„ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ù†ÙˆØ§Ù†');
                }
            } catch (err) {
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            } finally {
                refineTitleBtn.disabled = false;
                refineTitleBtn.innerHTML = '<i class="fas fa-magic"></i> ØªØ­Ø³ÙŠÙ† Ø¨Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ø°ÙƒÙŠ';
            }
        });

        function showResults(data) {
            currentProductData = data;
            productImage.src = data.image || '';
            productTitle.textContent = data.title || '';
            productPrice.textContent = `${data.price} ${data.currency || ''}`;
            productOriginalPrice.textContent = data.original_price ? `${data.original_price} ${data.currency || ''}` : '';
            productOriginalPrice.style.display = data.original_price ? 'block' : 'none';
            productDiscount.textContent = data.discount ? `-${data.discount}%` : '';
            productDiscount.style.display = data.discount ? 'inline-block' : 'none';
            
            // Show fetch method
            const fetchMethodTag = document.getElementById('fetchMethodTag');
            const fetchMethodName = document.getElementById('fetchMethodName');
            if (data.fetch_method) {
                fetchMethodTag.style.display = 'block';
                fetchMethodName.textContent = data.fetch_method;
            } else {
                fetchMethodTag.style.display = 'none';
            }
            
            linksContainer.innerHTML = '';
            linkSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø±Ø§Ø¨Ø· --</option>';
            linkTypes.forEach(type => {
                const link = data.links[type.key];
                if (link) {
                    linkSelect.innerHTML += `<option value="${link}">${type.title}</option>`;
                    linksContainer.innerHTML += `<div class="link-card">
                        <div class="link-header"><span>${type.title}</span><i class="fas ${type.icon}"></i></div>
                        <div class="link-text">${link}</div>
                        <div class="link-actions">
                            <button class="action-btn open-btn" onclick="window.open('${link}', '_blank')"><i class="fas fa-external-link-alt"></i> ÙØªØ­</button>
                            <button class="action-btn copy-btn" onclick="navigator.clipboard.writeText('${link}').then(() => showToast('ØªÙ… Ø§Ù„Ù†Ø³Ø®'))"><i class="fas fa-copy"></i> Ù†Ø³Ø®</button>
                            <button class="action-btn tele-btn" onclick="openTelePage('${link}')">ØµÙØ­Ø© Ø§Ù„Ù†Ø´Ø±</button>
                        </div>
                    </div>`;
                }
            });
            results.classList.add('show');
        }

        function openTelePage(link) {
            const params = new URLSearchParams({ title: currentProductData.title, image: currentProductData.image, price: currentProductData.price, link }).toString();
            window.open('/telegram.html?' + params, '_blank');
        }

        function showError(msg) { errorMsg.textContent = msg; errorMsg.classList.add('show'); }
        function showToast(msg) { toast.textContent = msg; toast.className = 'toast show'; setTimeout(() => toast.className = 'toast', 2500); }
        linkSelect.onchange = () => { publishBtn.disabled = !linkSelect.value; };

        publishBtn.onclick = async () => {
            const link = linkSelect.value;
            publishBtn.disabled = true;
            try {
                const res = await fetch('/api/publish-telegram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: currentProductData.title,
                        price: currentProductData.price,
                        link: link,
                        coupon: couponInput.value.trim() || null,
                        image: currentProductData.image,
                        settings: settings,
                        credentials: { telegramToken: settings.telegramToken, channelId: settings.channelId, channelId2: settings.channelId2, channelChoice: document.getElementById('channelSelect').value }
                    })
                });
                const result = await res.json();
                showToast(result.success ? 'ØªÙ… Ø§Ù„Ù†Ø´Ø±! âœ…' : 'ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±');
            } catch (e) { showToast('Ø®Ø·Ø£'); }
            finally { publishBtn.disabled = false; }
        };
        
        // Frame upload handler - save to localStorage for persistence
        document.getElementById('frameUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (event) => {
                const frameBase64 = event.target.result;
                localStorage.setItem('customFrame', frameBase64);
                
                const formData = new FormData();
                formData.append('frame', file);
                
                try {
                    const res = await fetch('/api/upload-frame', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await res.json();
                    if (result.success) {
                        document.getElementById('currentFramePreview').src = frameBase64;
                        showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø·Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­');
                    } else {
                        showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø·Ø§Ø±');
                    }
                } catch (err) {
                    showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø·Ø§Ø±');
                }
            };
            reader.readAsDataURL(file);
        });
        
        // Restore frame from localStorage on page load
        const savedFrame = localStorage.getItem('customFrame');
        if (savedFrame) {
            document.getElementById('currentFramePreview').src = savedFrame;
            
            // Re-upload to server if not exists
            fetch('/custom_frame.jpg', { method: 'HEAD' })
                .then(r => { if (!r.ok) throw new Error(); })
                .catch(() => {
                    fetch(savedFrame).then(r => r.blob()).then(blob => {
                        const formData = new FormData();
                        formData.append('frame', blob, 'frame.jpg');
                        fetch('/api/upload-frame', { method: 'POST', body: formData });
                    });
                });
        }
        
        // Logo upload handler
        document.getElementById('logoUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (event) => {
                const logoBase64 = event.target.result;
                localStorage.setItem('channelLogo', logoBase64);
                
                const formData = new FormData();
                formData.append('logo', file);
                
                try {
                    const res = await fetch('/api/upload-logo', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await res.json();
                    if (result.success) {
                        document.getElementById('currentLogoPreview').src = logoBase64;
                        document.getElementById('currentLogoPreview').style.opacity = '1';
                        showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„ÙˆÙ‚Ùˆ Ø¨Ù†Ø¬Ø§Ø­');
                    } else {
                        showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„ÙˆÙ‚Ùˆ');
                    }
                } catch (err) {
                    showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„ÙˆÙ‚Ùˆ');
                }
            };
            reader.readAsDataURL(file);
        });
        
        // Restore logo from localStorage on page load
        const savedLogo = localStorage.getItem('channelLogo');
        if (savedLogo) {
            document.getElementById('currentLogoPreview').src = savedLogo;
            document.getElementById('currentLogoPreview').style.opacity = '1';
            
            // Re-upload to server if not exists
            fetch('/watermark_logo.png', { method: 'HEAD' })
                .then(r => { if (!r.ok) throw new Error(); })
                .catch(() => {
                    fetch(savedLogo).then(r => r.blob()).then(blob => {
                        const formData = new FormData();
                        formData.append('logo', blob, 'logo.png');
                        fetch('/api/upload-logo', { method: 'POST', body: formData });
                    });
                });
        }
        
        // Logo position and size change handlers
        document.getElementById('logoPosition').addEventListener('change', (e) => {
            settings.watermarkPosition = e.target.value;
            localStorage.setItem('appSettings', JSON.stringify(settings));
        });
        document.getElementById('logoSize').addEventListener('change', (e) => {
            settings.watermarkSize = e.target.value;
            localStorage.setItem('appSettings', JSON.stringify(settings));
        });
        
        // Restore logo settings
        if (settings.watermarkPosition) document.getElementById('logoPosition').value = settings.watermarkPosition;
        if (settings.watermarkSize) document.getElementById('logoSize').value = settings.watermarkSize;

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');
    </script>
</body>
</html>